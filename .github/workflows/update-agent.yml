name: update-agent

on:
  workflow_dispatch:

jobs:
  update:
    name: Update
    runs-on: ubuntu-latest
    steps:
      - name: Update Agent
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          command_timeout: 200m
          script: |

            alias pm2=$HOME/.nvm/versions/node/v23.9.0/bin/pm2
            alias pnpm=$HOME/.local/share/pnpm/pnpm
            # We'll track if we successfully updated
            UPDATE_SUCCESS=true
            
            # Change directory
            cd $HOME/grantolf-eliza
            chmod +x ./client/node_modules/@esbuild/linux-x64/bin/esbuild
            # Only proceed if previous step succeeded
            if [ "$UPDATE_SUCCESS" = true ]; then
              if ! git reset --hard origin/main; then
                echo "Failed to reset git repository"
                UPDATE_SUCCESS=false
              fi
            fi
            
            # Only proceed if previous steps succeeded
            if [ "$UPDATE_SUCCESS" = true ]; then
              if ! git pull origin main; then
                echo "Failed to pull latest changes"
                UPDATE_SUCCESS=false
              fi
            fi
            
            pm2 stop grantolf
            pm2 delete grantolf

            # Try to build the new image without affecting the running container
            if [ "$UPDATE_SUCCESS" = true ]; then
              echo "Building new image..."
              if ! pnpm i && pnpm build; then
                echo "Failed to build new image"
                UPDATE_SUCCESS=false
                exit 1  # Exit with failure specifically when build fails
              fi
            fi
            
            # Only remove and restart grantolf if all previous steps (including build) succeeded
            if [ "$UPDATE_SUCCESS" = true ]; then
              echo "Build successful, updating running grantolf..."
              pm2 start pnpm --name "grantolf" -- start --character=./characters/grantolf.character.json
              echo "Update completed successfully."
            else
              echo "Update failed. Keeping current grantolf running."
              exit 1  # Exit with failure for any other failures
            fi